name: Release SoulOS

on:
  push:
    tags:
      - 'v*'

jobs:
  build-macos:
    permissions:
      contents: write
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: soul-os/src-tauri -> target

      - name: Install frontend dependencies
        working-directory: soul-os
        run: npm ci

      - name: Prepare bundled resources
        run: |
          RESOURCES=soul-os/src-tauri/resources

          # Download Node.js ARM64 macOS binary
          NODE_VERSION=20.18.1
          curl -fsSL "https://nodejs.org/dist/v${NODE_VERSION}/node-v${NODE_VERSION}-darwin-arm64.tar.gz" \
            | tar xz -C /tmp
          mkdir -p "${RESOURCES}/node"
          cp -R "/tmp/node-v${NODE_VERSION}-darwin-arm64/." "${RESOURCES}/node/"

          # Copy soul-engine source + install deps
          mkdir -p "${RESOURCES}/soul-engine/src"
          cp soul-engine/package.json soul-engine/package-lock.json "${RESOURCES}/soul-engine/"
          cp soul-engine/src/*.js "${RESOURCES}/soul-engine/src/"
          cd "${RESOURCES}/soul-engine" && npm ci --omit=dev && cd -

          # Copy soul-chain source + install deps
          mkdir -p "${RESOURCES}/soul-chain/src"
          cp soul-chain/package.json soul-chain/package-lock.json "${RESOURCES}/soul-chain/"
          cp soul-chain/src/*.js "${RESOURCES}/soul-chain/src/"
          cd "${RESOURCES}/soul-chain" && npm ci --omit=dev && cd -

      - name: Verify resources exist
        run: |
          echo "=== Resources ==="
          ls -la soul-os/src-tauri/resources/
          echo "=== Node binary ==="
          soul-os/src-tauri/resources/node/bin/node --version
          echo "=== soul-engine ==="
          ls soul-os/src-tauri/resources/soul-engine/
          echo "=== soul-chain ==="
          ls soul-os/src-tauri/resources/soul-chain/

      - name: Build Tauri app
        working-directory: soul-os
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ''
        run: npx tauri build --verbose

      - name: List build artifacts
        if: always()
        run: |
          echo "=== target/release/ ==="
          ls soul-os/src-tauri/target/release/ 2>/dev/null | head -20 || echo "No release dir"
          echo "=== Bundle directory ==="
          find soul-os/src-tauri/target/release/bundle/ -type f 2>/dev/null || echo "No bundle files found"

      - name: Create latest.json for updater
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          DMG_PATH="soul-os/src-tauri/target/release/bundle/dmg/SoulOS_${VERSION}_aarch64.dmg"
          SIG_PATH="soul-os/src-tauri/target/release/bundle/macos/SoulOS.app.tar.gz.sig"
          TAR_PATH="soul-os/src-tauri/target/release/bundle/macos/SoulOS.app.tar.gz"

          SIGNATURE=$(cat "${SIG_PATH}")
          PUB_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          DOWNLOAD_URL="https://github.com/${{ github.repository }}/releases/download/${GITHUB_REF_NAME}/SoulOS.app.tar.gz"

          cat > latest.json << EOF
          {
            "version": "${VERSION}",
            "notes": "See commit history for changes.",
            "pub_date": "${PUB_DATE}",
            "platforms": {
              "darwin-aarch64": {
                "signature": "${SIGNATURE}",
                "url": "${DOWNLOAD_URL}"
              }
            }
          }
          EOF

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          gh release create "${GITHUB_REF_NAME}" \
            --title "SoulOS ${GITHUB_REF_NAME}" \
            --notes "See commit history for changes." \
            "soul-os/src-tauri/target/release/bundle/dmg/SoulOS_${VERSION}_aarch64.dmg" \
            "soul-os/src-tauri/target/release/bundle/macos/SoulOS.app.tar.gz" \
            "soul-os/src-tauri/target/release/bundle/macos/SoulOS.app.tar.gz.sig" \
            "latest.json"
